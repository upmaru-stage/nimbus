dependencies:
  build:
    - nodejs-current
    - npm
    - vips-dev
  runtime:
    - nodejs-current
    - npm
    - bash
    - curl
    - s6
    - jq
    - ca-certificates
    - icu-data-full
    - nimbus-openrc
  trace: true

stack: alpine/3.18

build:
  command: |
    npm install
    npm run build
    
    cp -r .next/static .next/standalone/.next/
    cp -r public .next/standalone/
  destinations:
    - .next/standalone

run:
  name: nimbus
  services:
    - name: web
    - binary: node
    - path: /usr/bin
    - start:
        call: standalone/server.js

hook:
  post-deinstall: |
    rc-service nimbus stop
    rc-update del nimbus
  post-install: |
    rc-update add nimbus
  post-upgrade: |
    rc-service nimbus start
  pre-upgrade: |
    rc-service nimbus stop
